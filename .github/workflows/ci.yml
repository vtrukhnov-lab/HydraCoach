name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  analyze:
    name: ğŸ”¬ Analyze & Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.3'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ“ Check formatting
        run: dart format --set-exit-if-changed lib/ test/

      - name: ğŸ”¬ Flutter analyze
        run: flutter analyze

      - name: ğŸ” Check for print() statements
        run: |
          if grep -r "print(" lib/ --include="*.dart" | grep -v "// print(" | grep -v "//print("; then
            echo "âŒ Found print() statements! Use logger instead."
            exit 1
          fi
          echo "âœ… No print() statements found"

      - name: ğŸ“‹ Validate version sync
        run: |
          # Check version synchronization
          PUBSPEC_VERSION=$(grep "version:" pubspec.yaml | head -1 | sed 's/#.*//' | sed 's/.*version: *\([0-9.]*\)+.*/\1/' | tr -d ' ')
          PUBSPEC_BUILD=$(grep "version:" pubspec.yaml | head -1 | sed 's/#.*//' | sed 's/.*+\([0-9]*\).*/\1/' | tr -d ' ')

          GRADLE_VERSION=$(grep "versionName" android/app/build.gradle.kts | sed 's/.*versionName = "\([0-9.]*\)".*/\1/')
          GRADLE_BUILD=$(grep "versionCode" android/app/build.gradle.kts | sed 's/.*versionCode = \([0-9]*\).*/\1/')

          echo "ğŸ“„ pubspec.yaml: $PUBSPEC_VERSION+$PUBSPEC_BUILD"
          echo "ğŸ¤– build.gradle.kts: $GRADLE_VERSION (build $GRADLE_BUILD)"

          if [ "$PUBSPEC_VERSION" != "$GRADLE_VERSION" ]; then
            echo "âŒ Version mismatch: pubspec ($PUBSPEC_VERSION) != gradle ($GRADLE_VERSION)"
            exit 1
          fi

          if [ "$PUBSPEC_BUILD" != "$GRADLE_BUILD" ]; then
            echo "âŒ Build mismatch: pubspec ($PUBSPEC_BUILD) != gradle ($GRADLE_BUILD)"
            exit 1
          fi

          echo "âœ… Versions synchronized"

  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: analyze
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.3'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ§ª Run tests
        run: flutter test --coverage

      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  build-apk:
    name: ğŸ”¨ Build Debug APK
    runs-on: ubuntu-latest
    needs: analyze
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.3'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ”¨ Build debug APK
        run: flutter build apk --debug

      - name: ğŸ“¦ Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7

  security-check:
    name: ğŸ” Security Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check for secrets
        run: |
          echo "ğŸ” Checking for potential secrets..."

          # Check for common secret patterns
          if grep -rE "(api[_-]?key|apikey|api[_-]?secret|password|secret[_-]?key)" lib/ --include="*.dart" | grep -vE "(//|#|/\*|\*/|TODO|FIXME|example|placeholder|your[_-]key[_-]here|RemoteConfig|Remote Config)"; then
            echo "âš ï¸ Found potential secrets in code!"
            echo "Please use Firebase Remote Config or environment variables"
            exit 1
          fi

          echo "âœ… No hardcoded secrets found"

      - name: ğŸ” Check key.properties
        run: |
          if [ -f "android/key.properties" ]; then
            echo "âŒ key.properties found in repository!"
            echo "This file should be in .gitignore"
            exit 1
          fi
          echo "âœ… key.properties not in repository"
