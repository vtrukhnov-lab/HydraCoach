name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: ðŸš€ Create Release Build
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.3'
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Install dependencies
        run: flutter pub get

      - name: ðŸ”¬ Analyze code
        run: flutter analyze

      - name: ðŸ“‹ Extract version
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "version=$TAG" >> $GITHUB_OUTPUT
          echo "Version: $TAG"

      # Note: For actual signing, you would need to set up secrets:
      # KEYSTORE_BASE64, KEYSTORE_PASSWORD, KEY_ALIAS, KEY_PASSWORD
      # and decode the keystore file here

      - name: ðŸ”¨ Build APK
        run: flutter build apk --release

      - name: ðŸ”¨ Build AAB (App Bundle)
        run: flutter build appbundle --release
        # For signed builds, configure android/key.properties from secrets

      - name: ðŸ“Š Get file sizes
        id: sizes
        run: |
          APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
          AAB_SIZE=$(du -h build/app/outputs/bundle/release/app-release.aab | cut -f1)
          echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "aab_size=$AAB_SIZE" >> $GITHUB_OUTPUT
          echo "APK Size: $APK_SIZE"
          echo "AAB Size: $AAB_SIZE"

      - name: ðŸ“ Generate Release Notes
        id: release_notes
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            CHANGELOG=$(git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" | head -20)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --max-count=20)
          fi

          cat > release_notes.md <<EOF
          ## ðŸ“¦ HydraCoach v${{ steps.version.outputs.version }}

          **Build Date:** $(date +%Y-%m-%d)

          ### ðŸ“Š Build Info
          - **APK Size:** ${{ steps.sizes.outputs.apk_size }}
          - **AAB Size:** ${{ steps.sizes.outputs.aab_size }}
          - **Minimum Android:** API 28 (Android 9.0)
          - **Target SDK:** 35

          ### ðŸ“ Changes
          $CHANGELOG

          ### ðŸ“¥ Installation

          #### Testing (APK)
          \`\`\`bash
          adb install -r app-release.apk
          \`\`\`

          #### Production (AAB)
          Upload to Google Play Console

          ---
          ðŸ¤– Generated by GitHub Actions
          EOF

          cat release_notes.md

      - name: ðŸŽ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Release Complete
        run: |
          echo "ðŸŽ‰ Release v${{ steps.version.outputs.version }} created successfully!"
          echo "ðŸ“¦ APK: ${{ steps.sizes.outputs.apk_size }}"
          echo "ðŸ“¦ AAB: ${{ steps.sizes.outputs.aab_size }}"
